<!DOCTYPE html>
<html lang="en">
  <head>
    <title>API Documentation for Probe - NoTrace
    </title>
    <script type="text/javascript">var ghuser = 'rstuven'
  , ghproject = 'node-notrace';

</script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js"></script>
    <script src="/node-notrace/public/js/jq-mousewheel.js"></script>
    <script src="/node-notrace/public/js/antiscroll.js"></script>
    <script src="/node-notrace/public/js/prettify.js"></script>
    <script src="/node-notrace/public/js/main.js"></script>
    <link rel="stylesheet" href="/node-notrace/public/css/antiscroll.css" type="text/css" media="all">
    <link rel="stylesheet" href="/node-notrace/public/css/main.css" type="text/css" media="all">
    <link href="http://fonts.googleapis.com/css?family=Lato:300|Redressed" rel="stylesheet" type="text/css">
  </head>
  <body>
    <nav>
      <div class="box-wrap antiscroll-wrap">
        <div class="box">
          <div class="antiscroll-inner">
            <div class="box-inner">
              <ul class="sections">
              </ul>
            </div>
          </div>
        </div>
      </div>
      <ul class="pages">
        <li><a href="/node-notrace">Home</a>
        </li>
      </ul>
      <ul class="code">
        <li><a href="/node-notrace/code/consumer.html">Consumer</a>
        </li>
        <li><a href="/node-notrace/code/provider.html">Provider</a>
        </li>
        <li><a href="/node-notrace/code/probe.html">Probe</a>
        </li>
      </ul>
    </nav>
    <header>
      <h1><a href="/node-notrace">NoTrace</a>
      </h1>
      <div class="description"><p>Probing and monitoring library based on AMQP.</p>

        <div class="gh">
          <h4>Latest Update to Github
          </h4>
          <div id="commit"><span id="latestCommitTime">Loading...</span><a id="latestCommitURL"></a>
          </div>
          <div id="latestCommitMessage">Loading...
          </div>
          <div id="buttons">
            <div class="btn">
              <iframe src="http://markdotto.github.com/github-buttons/github-btn.html?user=rstuven&amp;repo=node-notrace&amp;type=watch&amp;count=true" allowtransparency="true" frameborder="0" scrolling="0" width="110px" height="20px">
              </iframe>
            </div>
            <div class="btn">
              <iframe src="http://markdotto.github.com/github-buttons/github-btn.html?user=rstuven&amp;repo=node-notrace&amp;type=fork&amp;count=true" allowtransparency="true" frameborder="0" scrolling="0" width="110px" height="20px">
              </iframe>
            </div>
            <div class="btn"><a href="htts://twitter.com/share" data-via="zxrs" data-related="zxrs" class="twitter-share-button">Tweet</a>
              <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
</script>
            </div>
          </div>
          <div id="links"><a id="repoIssues" href="https://github.com/rstuven/node-notrace/issues">GitHub Issues</a>
          </div>
        </div>
      </div>
    </header>
    <section id="content">
      <div id="code">
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>Probe</h1>
          </div>
          <div class="tags">
            <div class="tag"><span class="type">&#64;class</span><span class="desc">Probe</span>
            </div>
          </div>
          <div class="description"><p>This class represents an instrumentation point.</p>
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>exports.Probe = Probe = (function(_super) {

    __extends(Probe, _super);

    function Probe() {
      var config, types;
      config = arguments[0], types = 2 &lt;= arguments.length ? __slice.call(arguments, 1) : [];
      this.id = uuid();
      this.consumerIds = [];
      this.consumerTimers = {};
      this.disableDelay = new Delay;
      if (typeof config === 'string') {
        config = {
          name: config,
          types: types
        };
      }</code>
            </pre>
          </div>
        </article>
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>.name</h1>

<p>Gets the probe name</p>
          </div>
          <div class="description">
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>if (!(config.name != null) || typeof config.name !== 'string' || config.name === '') {
        throw new Error(&quot;Argument is missing: 'name'&quot;);
      }
      if (config.name.match(/[\.#*]/)) {
        throw new Error('Invalid character in name. The following are reserved: .#*');
      }
      this.name = config.name;</code>
            </pre>
          </div>
        </article>
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>.types</h1>

<p>Gets the array of argument types.</p>
          </div>
          <div class="description">
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>if ((!(config.types != null)) || (!config.types instanceof Array) || (config.types.length === 0)) {
        this.types = ['number'];
      } else {
        this.types = config.types;
      }</code>
            </pre>
          </div>
        </article>
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>.enabled</h1>

<p>Gets the enabled status.</p>
          </div>
          <div class="description">
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>this.enabled = config.enabled === true;</code>
            </pre>
          </div>
        </article>
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>.instant</h1>

<p>Gets the instant property value.</p>
          </div>
          <div class="description">
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>this.instant = config.instant === true;</code>
            </pre>
          </div>
        </article>
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>.sampleThreshold</h1>

<p>Gets the sample threshold value.</p>
          </div>
          <div class="description">
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>this.sampleThreshold = !(config.sampleThreshold != null) ? SAMPLE_THRESHOLD : config.sampleThreshold;</code>
            </pre>
          </div>
        </article>
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>.args</h1>

<p>Gets the arguments.</p>
          </div>
          <div class="description">
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>if (config.args != null) {
        if (config.args instanceof Array) {
          this.args = config.args;
        } else {
          this.args = [config.args];
        }
        if (this.args.length === 1 &amp;&amp; (typeof this.args[0] === 'function')) {
          this.args = this.args[0];
        }
      } else {
        this.args = this.types.map(function(type) {
          if (type === 'number') {
            return 0;
          } else {
            return '';
          }
        });
      }</code>
            </pre>
          </div>
        </article>
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>.hits</h1>

<p>Gets the hits property value.</p>
          </div>
          <div class="description">
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>this.hits = 0;
    }</code>
            </pre>
          </div>
        </article>
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>.update()</h1>
          </div>
          <div class="tags">
            <div class="tag"><span class="type">&#64;param</span><span class="types">&#123; params &#125;</span><span class="name">args</span><span class="desc">The arguments of the probe.</span>
            </div>
          </div>
          <div class="description"><p>Updates a probe.</p>

<h2>Example</h2>

<pre><code>probe.update(123, 'abc');
</code></pre>
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>Probe.prototype.update = function() {
      var args,
        _this = this;
      args = 1 &lt;= arguments.length ? __slice.call(arguments, 0) : [];
      this.args = args;
      this.hits++;
      if (this.enabled &amp;&amp; this.instant) {
        return this.evaluate(this.args, function(err, evaluated, timestamp) {
          return _this.sample(null, null, evaluated, timestamp);
        });
      }
    };</code>
            </pre>
          </div>
        </article>
        <article id="undefined-section" class="codeblock">
          <div class="header"><h1>.increment()</h1>
          </div>
          <div class="tags">
            <div class="tag"><span class="type">&#64;param</span><span class="types">&#123; Number &#125;</span><span class="name">offset</span><span class="desc">(Optional) The increment offset. It can ben positive or negative. Default: +1.</span>
            </div>
            <div class="tag"><span class="type">&#64;param</span><span class="types">&#123; Number &#125;</span><span class="name">index</span><span class="desc">(Optional) The argument index. Default: 0.</span>
            </div>
          </div>
          <div class="description"><p>Increments a probe.</p>

<h2>Example</h2>

<pre><code>probe.increment();
</code></pre>
          </div>
          <div class="view-source">View Source
          </div>
          <div class="code-wrap">
            <pre class="source prettyprint"><code>Probe.prototype.increment = function(offset, index) {
      var arg;
      if (offset == null) offset = 1;
      if (index == null) index = 0;
      arg = this.args[index];
      if (typeof arg !== 'number') {
        throw new Error(&quot;Argument of wrong type. args in index &quot; + index + &quot; can not be incremented.&quot;);
      }
      this.args[index] = arg + offset;
      this.hits++;
      if (this.enabled &amp;&amp; this.instant) return this.sample(null, null, this.args);
    };

    Probe.prototype.sample = function(consumerId, callback, args, timestamp) {
      var go, now,
        _this = this;
      now = Date.now();
      if (!(this.sampleThreshold === 0 || !(this.lastTimestamp != null) || (now - this.lastTimestamp) &gt;= this.sampleThreshold)) {
        return;
      }
      this.lastTimestamp = now;
      go = function(err, v, ts) {
        var consumerIds, sample;
        sample = {
          timestamp: ts || Date.now(),
          hits: _this.hits,
          args: v,
          error: err
        };
        consumerIds = consumerId != null ? [consumerId] : _this.consumerIds;
        _this.emit('sample', sample, consumerIds);
        if (callback != null) return callback(null, sample, consumerIds);
      };
      if (args != null) {
        return go(null, args, timestamp);
      } else {
        return this.evaluate(this.args, go);
      }
    };

    Probe.prototype.evaluate = function(args, callback) {
      var cb, r;
      if (typeof args === 'function') {
        cb = function(err, result, timestamp) {
          if (err) {
            callback(err);
            return;
          }
          if (result instanceof Array) {
            return callback(null, result, timestamp);
          } else {
            return callback(null, [result], timestamp);
          }
        };
        try {
          r = args(cb);
        } catch (e) {
          callback(e);
          return;
        }
        if (r != null) return cb(null, r);
      } else {
        return callback(null, args);
      }
    };

    Probe.prototype.setEnabled = function(enabled) {
      var consumerId, timer, _ref;
      this.enabled = enabled;
      if (!enabled) {
        _ref = this.consumerTimers;
        for (consumerId in _ref) {
          timer = _ref[consumerId];
          timer.stop();
        }
        this.consumerTimers = {};
        return this.consumerIds = [];
      }
    };

    Probe.prototype.enableForConsumer = function(consumerId, interval, probeKey) {
      var newConsumerId,
        _this = this;
      if (this.instant) {
        newConsumerId = -1 === this.consumerIds.indexOf(consumerId);
        if (newConsumerId) this.consumerIds.push(consumerId);
      } else {
        newConsumerId = !this.consumerTimers.hasOwnProperty(consumerId);
        if (newConsumerId) this.sampleByInterval(consumerId, interval);
      }
      this.enabled = true;
      return this.disableDelay.start(PROBE_DISABLE_DELAY, function() {
        console.log('disable', probeKey);
        return _this.setEnabled(false);
      });
    };

    Probe.prototype.sampleByInterval = function(consumerId, interval) {
      var timer,
        _this = this;
      if (interval === 0) return;
      timer = this.consumerTimers[consumerId];
      if (!(timer != null)) {
        timer = new Timer;
        this.consumerTimers[consumerId] = timer;
      }
      return timer.start(interval, function() {
        return _this.sample(consumerId);
      });
    };

    Probe.prototype.stop = function(consumerId) {
      var index, timer;
      index = this.consumerIds.indexOf(consumerId);
      if (index !== -1) this.consumerIds.splice(index, 1);
      timer = this.consumerTimers[consumerId];
      if (timer != null) {
        timer.stop();
        return delete this.consumerTimers[consumerId];
      }
    };

    return Probe;

  })(EventEmitter);

}).call(this);</code>
            </pre>
          </div>
        </article>
      </div>
    </section>
    <footer>
      <div class="branding">NoTrace site generated by&nbsp;<a href="http://codexjs.com">codex</a>, based on chai template.

      </div>
    </footer>
  </body>
</html>